<!DOCTYPE html>
<html>
<head>
  <title>Screen Watcher</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1>Screen Watcher</h1>
  <video id="videoPlayer" controls autoplay></video>

  <script>
    const videoElement = document.getElementById('videoPlayer');
    const socket = io();
    const mediaSource = new MediaSource();

    videoElement.src = URL.createObjectURL(mediaSource);

    let sourceBuffer;
    let queue = [];

    mediaSource.addEventListener('sourceopen', () => {
      sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8, opus"');

      // Handle updates to the SourceBuffer
      sourceBuffer.addEventListener('updateend', () => {
        if (queue.length > 0 && !sourceBuffer.updating) {
          sourceBuffer.appendBuffer(queue.shift());
        }
      });

      socket.on('videoData', (base64Data) => {
        // Decode base64 to binary
        const binaryString = window.atob(base64Data);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);

        for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }

        const buffer = bytes.buffer;

        if (sourceBuffer && !sourceBuffer.updating) {
          sourceBuffer.appendBuffer(buffer);
        } else {
          queue.push(buffer); // Queue data if the SourceBuffer is busy
        }
      });
    });
  </script>
</body>
</html>

